DICOM Anypoint Connector
========================
Connector that implements [Query/Retrieve Service Class](https://dicom.nema.org/dicom/2013/output/chtml/part04/chapter_C.html) operations.  
Copyright (c) 2022 The Johns Hopkins University  
David J. Talley, [Technology Innovation Center](https://tic.jh.edu), [Precision Medicine Analytics Platform](https://pm.jh.edu)

Operations
----------
### Store SCP - C-STORE as a Service Class Provider
A listener that receives DICOM files. Generates a `org.dcm4che3.data.Attributes` object with the DICOM file content and the following Inbound Properties:
* AffectedSOPClassUID
* AffectedSOPInstanceUID
* ImplementationClassUID
* ImplementationVersionName
* MessageID
* MoveOriginatorApplicationEntityTitle
* MoveOriginatorMessageID
* Priority
* SourceApplicationEntityTitle
* TransferSyntaxUID

### Store SCU - C-STORE as a Service Class User
Uploads a DICOM file to some listener that's acting as a Store SCP. Requires that payload be a `org.dcm4che3.data.Attributes` object, which can be generated by the Store SCP or Read File operations. Also requires that the Transfer Syntax UID is in the Inbound Properties or Outbound Properties, which is also set by both Store SCP and Read File.

### Find SCU - C-FIND as a Service Class User
Accepts a Map of query parameters (see below) to perform a query, returning results in an array of maps. Query parameters with blank string values are not included in the criteria, but will be included in the results.

Example query that returns all files that match a PatientID and AccessionNumber, and includes each file's SeriesInstanceUID and SOPClassUID in the results.
```
{
	"PatientID": "E000000000",
	"AccessionNumber": "00000000",
	"SeriesInstanceUID": "",
	"SOPClassUID": ""
}
```

### Get SCU - C-GET as a Service Class User
Accepts a Map of query parameters (see below). Saves each DICOM file to a folder, returning an
ArrayList of their filenames.

The optional `Notification Reference` parameter will accept the full path to a Java class
instance that implements `edu.jh.pm.dicom.store.Notification`. After each received file is
saved, that Notification is called with the full path filename.

An optional list of SOP Classes and be provided (see below). If left blank, a default list will be used.

The Inbound Property `StatusText` will have the value `Success` if all files were successfully downloaded.

### Move SCU - C-MOVE as a Service Class User
Accepts a Map of query parameters (see below). Specifies the Application Entity that will receive 
the DICOM files as a Store SCP, which can either be another flow or some other listener.

An optional list of SOP Classes and be provided (see below). If left blank, a default list will be used.

The Inbound Property `StatusText` will have the value `Success` if all files were successfully processed.

### Store File - Saves the result of Store SCP to a file
Saves a DICOM file to the file system. Requires that payload be a `org.dcm4che3.data.Attributes` object, which can be generated by the Store SCP or Read File operations. Also requires that the Transfer Syntax UID is in the Inbound Properties or Outbound Properties, which is also set by both Store SCP and Read File.

### Read File
Reads a DICOM file from the file system, creating a `org.dcm4che3.data.Attributes` object as the payload. Puts the file's meta data into the Inbound Properties.

### Set Tags
Adds or changes DICOM tags on a file. Requires that payload be a `org.dcm4che3.data.Attributes` object, which can be generated by the Store SCP or Read File operations. Tag names follow the same name convension as query parameters (see below).

Query Parameters
----------------
Query parameters are used as payload input to Find SCU, Move SCU, and Get SCU operations. It's a map of name/value pairs, where the name is either the Keyword of a registered data element (e.g. https://dicom.nema.org/dicom/2013/output/chtml/part06/chapter_6.html) or its numeric ID (which can also be a private tag). The name can be in any of the following formats:

| Format | Example | RegEx Pattern  |
| :--- | :--- | :--- |
| Hex | "0x00100020" | ^0[xX][0-9a-fA-F]{8}$ |
| Hex Pair | "0010,0020" | ^([0-9a-fA-F]{4})\W([0-9a-fA-F]{4})$ |
| Integer | "1048608" | ^\d$ |
| Keyword | "PatientID" |  |

Example query using Keywords:
```
{
	"PatientID": "E000000000",
	"AccessionNumber": "00000000"
}
```

Example query using Hex Pairs:
```
{
	"0010,0020": "E000000000",
	"0008,0050": "00000000"
}
```

SOP Classes
-----------
A list of Storage [Service-Order Pair (SOP) Classes](https://www.dicomlibrary.com/dicom/sop/) and their supported [Transfer Syntax UIDs](https://www.dicomlibrary.com/dicom/transfer-syntax/) is used by the Move SCU and Get SCU operations to communicate to the remote SCP what SOP Classes and Transfer Syntaxes are supported. DICOM limits the number of SOP classes you can specify to 128.

SOP Classes and Transfer Syntaxes can be specified using either their UID string (e.g. 1.2.840.10008.1.2) or the name associated with those UID strings, as defined in the `org.dcm4che3.data.UID` class (e.g. ImplicitVRLittleEndian). In the map, the SOP Class is the property key and the Transfer Syntaxes are listed in the property value as either a string or array of string.

| Description | Example |
| :--- | :--- |
| UID strings with array of transfer syntaxes | `{ "1.2.840.10008.5.1.4.1.1.88.11": ["1.2.840.10008.1.2","1.2.840.10008.1.2.1","1.2.840.10008.1.2.1.99"] }` |
| Class names with array of transfer syntaxes | `{ "BasicTextSRStorage": ["ImplicitVRLittleEndian","ExplicitVRLittleEndian","DeflatedExplicitVRLittleEndian"] }` |
| Class names with comma-separated list of transfer syntaxes | `{ "BasicTextSRStorage": "ImplicitVRLittleEndian,ExplicitVRLittleEndian,DeflatedExplicitVRLittleEndian" }` |

Mule supported versions
-----------------------
Mule 3

Reference in pom.xml
--------------------
```
<dependency>
    <groupId>edu.jh.pm</groupId>
    <artifactId>dicom-connector</artifactId>
    <version>3.1.0</version>
</dependency>
```

License
-------
[Apache License, Version 2.0](http://www.apache.org/licenses/LICENSE-2.0)  
[Creative Commons Attribution 4.0 International License](http://creativecommons.org/licenses/by/4.0/)